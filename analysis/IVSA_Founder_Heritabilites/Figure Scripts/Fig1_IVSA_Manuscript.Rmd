---
title: "Fig1_IVSA_Manuscript"
author: "Udita Datta"
date: "11/18/2020"
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: true
    fig_retina: true
    self_contained: true
    code_folding: show
    theme: flatly
    highlight: default
    df_print: paged
---
### Purpose of analysis

This analysis is performed to analyze intravenous self-administration (IVSA) data from the founder populations of the Diversity Outbred (DO) and Collaborative Cross (CC)for the generation of Fig 1 an associated stats of the IVSA manuscript.

## Data Provenance and Definition

### Data Provenance

The original file used to generate the data analyzed here was `IVSA export to 6-30-19_preprocessed_fixed_multivariate.xlsx`. This file was generated by Matt Dunn while working for Vivek Philip.

The data were collected over years by the CSNA RAs. Chief contributors include Troy Wilcox, Tyler Roy, and Michael Leonardo. The RAs were led by technical manager Leona Gagnon.

### Data Preprocessing

The preprocessing RMarkdown notebook `IVSA_import_preprocess.Rmd` used the original Excel spreadsheet `IVSA export to 6-30-19_preprocessed_fixed_multivariate.xlsx` as the input for a few preprocessing steps:

* Preprocessing and coercion of all variables to the correct data type (e.g. removing `x` and replacing it with `NA`, then changing all numeric variables to a numeric type)
* Appending of PED IDs where appropriate
* Merging of LIMS data -- including strain, sex, date of testing information, and exit reasons -- into descriptive columns (from JAXLIMS data that exported and pre-processed on 2019-09-26)
* Renaming of variable names to ease programmatic access

### Data Dictionary of IVSA Variables

These variables have been alterred from the original output file. Variable name alteration was done in the RMarkdown notebook `IVSA_import_preprocess.Rmd`. The original file had inconsistent column header IDs that were difficult to query programatically and reference using regular expressions. The correspondence to the current variable names and the original names is in the IVSA metadata sheet. Abbreviations are as follows:

* Prefices
  * Prefix `AQ_` is acquisition
  * Prefix `DR_` is dose-response
  * Prefix `EX_` is extinction
  * Prefix `RI_` is reinstatement
  * Prefix `WT_` is weight

* Phenotypes
  * `SessionsToAcquisition` is the number of sessions it took for the animal to acquire IVSA
  * `ALP` is active lever presses
  * `ILP` is inactive lever presses
  * `Inf` is infusions
  * `IEI` is inter-event interval
  * `pAP` is percentage of active presses
  * `TCI` is total cocaine intake
  * `TfACDiE` is total for all cocaine doses in experiment
  * `Tf7Es` is total for all seven extinction sessions
  * `RIn` is reinstatement
  * `StS` is sessions to stabilization
  * `AUC` is area under the curve
  
* General terms  
  * `mgkg` is milligrams per kilogram, mg/kg, and is displayed in NpNNN with the p standing for the decimal point (e.g., 0p032mgkg is 0.032 mg/kg)
  * `X2` is second exposure, which happens on the 1.0 mg/kg dose to stabilize the mouse.
  * `dTO` is during time out
  * `Mean` is mean
  * `Total` is total
  * `Variance` is variance
  * `CoV` is coefficient of variation, ${\sigma}\over{\mu}$
  * `TfASoTD` is total for all sessions on this dose
  * `Mean2s` is mean of two sessions
  * `Sal` is saline

# Setup

## Environment Setup

### Working directory

All chunks will run in the working folder for this experiment.
foun
### Working directory

All chunks will run in the working folder for this experiment.
foun
```{r setup, warning=FALSE}
script_root_dir = "C:/Users/dattau/Documents/IVSA_Proj_org/IVSA/IVSA"
knitr::opts_knit$set(root.dir = script_root_dir)
```

### R libraries

Calling R libraries necessary for this analysis.

```{r libraries, warning=FALSE}
library("MASS")
library("cowplot")
library("lubridate")
library("ggbeeswarm")
library("readxl")
library("tidyr")
library("dplyr")
library("DT")
library("ANOM")
library("multcomp")
```

## Dataset Setup

### Importing data

The IVSA and novelty data have already been preprocessed using the `IVSA_novelty_import_preprocess.Rmd` script.

```{r import_data, warning=FALSE}
# Taking the most recent datasets
data_path = paste(script_root_dir,"/preprocessed_IVSA_data/", sep = "")
IVSA_datasets = data.frame(files = list.files(path = data_path, pattern = "\\d{4}-\\d{2}-\\d{2}\\.RDS$"),
                           date = ymd(gsub("^.*_(\\d{4}-\\d{2}-\\d{2})\\.RDS$","\\1", 
                                           list.files(path = data_path, 
                                                      pattern = "\\d{4}-\\d{2}-\\d{2}\\.RDS$")), 
                                      tz = "America/New_York"),
                           stringsAsFactors = FALSE)
most_recent_datasets = paste(data_path, IVSA_datasets[which(IVSA_datasets$date == max(IVSA_datasets$date)),"files"], sep = "")

# IVSA
IVSA_raw_file = most_recent_datasets[grep("IVSA_raw", most_recent_datasets)]
IVSA_metadata_file = most_recent_datasets[grep("IVSA_metadata", most_recent_datasets)]
IVSA_raw = readRDS(IVSA_raw_file)
row.names(IVSA_raw) = IVSA_raw$DE_Subject
IVSA_metadata = readRDS(IVSA_metadata_file)
head(IVSA_raw)
```
Getting founders key file.

```{r founders_key_import, warning=FALSE}
founders_key = readRDS("C:/Users/dattau/Documents/IVSA_Proj_org/IVSA/IVSA/csna_project_4_behavior/data/cc_do_founders_key.RDS")
row.names(founders_key) = founders_key$strain
founders_key[9,1] = "J:DO"
founders_key[9,2] = "DO"
founders_key[9,5] = "#000000"
founders_key[9,6] = "#000000"
row.names(founders_key) = founders_key$strain
head(IVSA_raw)
```

### Filtering IVSA data for DO Founders

Getting IVSA data for the eight founders, old DO and CC  strains.

```{r filter_for_founders, warning=FALSE}
founders_IVSA = IVSA_raw %>%
  filter(DE_Strain %in% founders_key$strain)
#rm(list = c("IVSA_raw"))
founders_IVSA = as.data.frame(founders_IVSA)

founders_IVSA$DE_Strain = factor(founders_IVSA$DE_Strain,
                                 levels = founders_key$strain,
                                 ordered = TRUE)


Old_DO <- founders_IVSA %>% 
  filter(DE_birth_date_year == 2016,
         DE_Strain == "J:DO")


New_DO <- founders_IVSA %>% 
  filter(DE_birth_date_year != 2016,
         DE_Strain == "J:DO")

No_DO <- founders_IVSA %>% 
  filter(DE_Strain != "J:DO")

founders_IVSA <- merge(Old_DO,No_DO, all = TRUE)

ids <- c("A2063", "A2810", "A2418", "A3262", "A3261", "A3052", "A3257", "A3256", "A3051", "A2986")
rm.ids <- which(founders_IVSA$DE_Subject %in% ids)
founders_IVSA.p1  <- founders_IVSA[-rm.ids,]

founders_IVSA = founders_IVSA.p1

```
Getting CC key.

```{r}
CC_key = unique(IVSA_raw$DE_Strain)
CC_key = CC_key[grep("^CC\\d{3}/",CC_key)]
#CC_key = stringr::str_extract(CC_key, "^.{5}")
CC_key
CC_founders_IVSA_CC = IVSA_raw %>%
  filter(DE_Strain %in% c(CC_key))

CC_founders_IVSA_CC$DE_Strain = stringr::str_extract(CC_founders_IVSA_CC$DE_Strain, "^.{5}")
head(CC_founders_IVSA_CC)
```

Merging old DO, founders and CC
```{r}
CC_founders_IVSA <- rbind(founders_IVSA, CC_founders_IVSA_CC)
```

The environment and datasets are ready for analysis.
# Analysis

## Acquisition

### Filtering Acquisition data

First, filtering the acquisition data.

```{r}
CC_founders_acquisition = CC_founders_IVSA %>%
  dplyr::filter(!(DE_Exit_Reason == "FD" & is.na(AQ_SessionsToAcquisition)))
CC_founders_acquisition[which(CC_founders_acquisition$DE_Exit_Reason == "IVSA Failed Acquisition"),"AQ_SessionsToAcquisition"] = 28
CC_founders_acquisition[which(CC_founders_acquisition$DE_Exit_Reason == "IVSA Acquisition Only"),"AQ_SessionsToAcquisition"] = 28
table(CC_founders_acquisition[which(is.na(CC_founders_acquisition$AQ_SessionsToAcquisition)),"DE_Exit_Reason"])
# CC_founders_acquisition = CC_founders_acquisition %>%
#   dplyr::filter(!is.na(AQ_SessionsToAcquisition))
CC_founders_acquisition %>% 
  dplyr::filter(DE_Strain == "CC020")
```
### Percent Acquired
Looking for differences in percent animals acquiring IVSA. Calculating population grand mean for overlaying on Percent Acquired bar plot

```{r}
founders_key
CC_founders_percent_acquisition = CC_founders_acquisition %>% 
  dplyr::filter((DE_Exit_Reason == "Finished Pipeline") | (DE_Exit_Reason == "IVSA Acquisition Only")) %>%
  group_by(DE_Strain) %>%
  summarize(n_finished = length(which(DE_Exit_Reason == "Finished Pipeline")),
            n_aq_only = length(which(DE_Exit_Reason == "IVSA Acquisition Only"))) %>%
  mutate(percent_acquired = 100 * (n_finished / (n_finished + n_aq_only)))

CC_founders_percent_acquisition = as.data.frame(CC_founders_percent_acquisition)
row.names(CC_founders_percent_acquisition) = CC_founders_percent_acquisition$DE_Strain
CC_founders_percent_acquisition$Color = rep("#CCCCCC", times = nrow(CC_founders_percent_acquisition))
CC_founders_percent_acquisition$DE_Strain = factor(CC_founders_percent_acquisition$DE_Strain,
                                                   levels = CC_founders_percent_acquisition[order(CC_founders_percent_acquisition$percent_acquired),"DE_Strain"],
                                                   ordered = TRUE)
CC_founders_percent_acquisition$Color = rep("#CCCCCC", times = nrow(CC_founders_percent_acquisition))
CC_founders_percent_acquisition[row.names(founders_key),"Color"] = founders_key$collaborative_cross_color_broman

CC_percent_acquisition_GrandMean = mean(CC_founders_percent_acquisition$percent_acquired, na.rm = TRUE)
CC_percent_acquisition_GrandMean

CC_percent_acquisition_plot = ggplot(data = CC_founders_percent_acquisition, aes(x = DE_Strain, y = percent_acquired, fill = DE_Strain)) +
  geom_col(color = "#000000", width = 1) +
  scale_fill_manual(values = CC_founders_percent_acquisition[order(CC_founders_percent_acquisition$DE_Strain),"Color"]) +
  theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust=0.5), legend.position="none") +
  xlab(NULL) +
  ylab("Percent Acquiring IVSA") 
# + geom_hline(yintercept=CC_percent_acquisition_GrandMean, linetype="dashed", color = "red")
CC_percent_acquisition_plot
CC_founders_percent_acquisition

CC_percent_acquisition_plot <- CC_percent_acquisition_plot + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
CC_percent_acquisition_plot
ggsave("CC_percent_acquisition_plot.pdf")

```
### Percent Acquired
Looking for differences in percent animals acquiring IVSA but without DO. Calculating population grand mean for overlaying on Percent Acquired bar plot.

```{r}
founders_key_no_DO = founders_key %>% dplyr::filter((strain != "J:DO"))
CC_founders_percent_acquisition = CC_founders_acquisition %>% 
  dplyr::filter((DE_Exit_Reason == "Finished Pipeline") | (DE_Exit_Reason == "IVSA Acquisition Only"))  %>%
  group_by(DE_Strain) %>%
  summarize(n_finished = length(which(DE_Exit_Reason == "Finished Pipeline")),
            n_aq_only = length(which(DE_Exit_Reason == "IVSA Acquisition Only"))) %>%
  mutate(percent_acquired = 100 * (n_finished / (n_finished + n_aq_only)))

CC_founders_percent_acquisition = CC_founders_percent_acquisition %>% dplyr::filter((DE_Strain != "J:DO"))


CC_founders_percent_acquisition = as.data.frame(CC_founders_percent_acquisition)


row.names(CC_founders_percent_acquisition) = CC_founders_percent_acquisition$DE_Strain
CC_founders_percent_acquisition$Color = rep("#CCCCCC", times = nrow(CC_founders_percent_acquisition))
CC_founders_percent_acquisition$DE_Strain = factor(CC_founders_percent_acquisition$DE_Strain,
                                                   levels = CC_founders_percent_acquisition[order(CC_founders_percent_acquisition$percent_acquired),"DE_Strain"],
                                                   ordered = TRUE)
CC_founders_percent_acquisition$Color = rep("#CCCCCC", times = nrow(CC_founders_percent_acquisition))
CC_founders_percent_acquisition[row.names(founders_key_no_DO),"Color"] = founders_key_no_DO$collaborative_cross_color_broman

CC_percent_acquisition_GrandMean = mean(CC_founders_percent_acquisition$percent_acquired, na.rm = TRUE)
CC_percent_acquisition_GrandMean

CC_percent_acquisition_plot = ggplot(data = CC_founders_percent_acquisition, aes(x = DE_Strain, y = percent_acquired, fill = DE_Strain)) +
  geom_col(color = "#000000", width = 1) +
  scale_fill_manual(values = CC_founders_percent_acquisition[order(CC_founders_percent_acquisition$DE_Strain),"Color"]) +
  theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust=0.5), legend.position="none") +
  xlab(NULL) +
  ylab("Percent Acquiring IVSA") 
# + geom_hline(yintercept=CC_percent_acquisition_GrandMean, linetype="dashed", color = "red")
CC_percent_acquisition_plot
CC_founders_percent_acquisition

CC_percent_acquisition_plot <- CC_percent_acquisition_plot + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
CC_percent_acquisition_plot

range
```
Looking for differences in proportion of mice meeting acquisition criteria in the founder and CC.
```{r}
founders_key_no_DO = founders_key %>% dplyr::filter((strain != "J:DO"))
CC_founders_proportion_acquisition = CC_founders_acquisition %>% 
  dplyr::filter((DE_Exit_Reason == "Finished Pipeline") | (DE_Exit_Reason == "IVSA Acquisition Only"))  %>%
  group_by(DE_Strain) %>%
  summarize(n_finished = length(which(DE_Exit_Reason == "Finished Pipeline")),
            n_aq_only = length(which(DE_Exit_Reason == "IVSA Acquisition Only")),
            n_total = (n_finished + n_aq_only))%>%
  mutate(proportion_acquired = (n_finished / (n_finished + n_aq_only)))

CC_founders_proportion_acquisition = CC_founders_proportion_acquisition %>% dplyr::filter((DE_Strain != "J:DO"))


CC_founders_proportion_acquisition = as.data.frame(CC_founders_proportion_acquisition)

prop.test(CC_founders_proportion_acquisition$n_finished, CC_founders_proportion_acquisition$n_total)
```

### Sessions to Acquisition

Looking for differences in sessions to acquisition in the CC. 
Original Format
```{r}
CC_StA_summary = CC_founders_acquisition %>%
  group_by(DE_Strain) %>%
  summarize(StA_mean = mean(AQ_SessionsToAcquisition, na.rm = TRUE),
            StA_sem = sd(AQ_SessionsToAcquisition, na.rm = TRUE) / sqrt(length(which(!is.na(AQ_SessionsToAcquisition)))),
            StA_n = length(which(!is.na(AQ_SessionsToAcquisition)))) %>%
  mutate(StA_ul = StA_mean + StA_sem,
         StA_ll = StA_mean - StA_sem)
CC_StA_summary = as.data.frame(CC_StA_summary)
CC_StA_summary$Colors = rep("#CCCCCC", times = nrow(CC_StA_summary))
CC_StA_summary[which(CC_StA_summary$DE_Strain %in% founders_key$strain),"Colors"] = founders_key[CC_StA_summary[which(CC_StA_summary$DE_Strain %in% founders_key$strain),"DE_Strain"],"collaborative_cross_color_broman"]
CC_StA_summary$DE_Strain = factor(CC_StA_summary$DE_Strain,
                                  levels = CC_StA_summary[order(CC_StA_summary$StA_mean, decreasing = FALSE),"DE_Strain"],
                                  ordered = TRUE)
CC_StA_summary$xlabel = paste(as.character(CC_StA_summary$DE_Strain)," (n = ", CC_StA_summary$StA_n, ")", sep = "")
CC_StA_plot = ggplot(data = CC_StA_summary, aes(x = DE_Strain, y = StA_mean, fill = DE_Strain)) +
  geom_col(color = "#000000") +
  geom_errorbar(aes(ymin = StA_ll, ymax = StA_ul), width = 0.5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5), legend.position="none") +
  scale_fill_manual(values = CC_StA_summary[order(CC_StA_summary$DE_Strain),"Colors"]) +
  xlab(NULL) +
  ylab("Sessions to Acquistion of IVSA") +
  scale_x_discrete(labels = CC_StA_summary[order(CC_StA_summary$DE_Strain),"xlabel"]) 
  
CC_StA_plot

CC_StA_plot <- CC_StA_plot + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
CC_StA_plot
ggsave("CC_StA_plot.pdf")

CC_founders_IVSA %>%
  group_by(DE_Strain, DE_Sex)%>%
  summarize(n())

```

Calculating population grand mean for overlaying on Sessions to acquisition bar plot
```{r}
CC_StA_GrandMean = mean(CC_founders_acquisition$AQ_SessionsToAcquisition, na.rm = TRUE)
CC_StA_GrandMean
```
#Sessions to Acquisition

Plotting Sessions to acquisition in the Founders, CC and DO with axis modified and grand mean overlaid.
New Format fig.
```{r}
CC_StA_summary = CC_founders_acquisition %>%
  group_by(DE_Strain) %>%
  summarize(StA_mean = mean(AQ_SessionsToAcquisition, na.rm = TRUE),
            StA_sem = sd(AQ_SessionsToAcquisition, na.rm = TRUE) / sqrt(length(which(!is.na(AQ_SessionsToAcquisition)))),
            StA_n = length(which(!is.na(AQ_SessionsToAcquisition)))) %>%
  mutate(StA_ul = StA_mean + StA_sem,
         StA_ll = StA_mean - StA_sem)
CC_StA_summary = as.data.frame(CC_StA_summary)
CC_StA_summary$Colors = rep("#CCCCCC", times = nrow(CC_StA_summary))
CC_StA_summary[which(CC_StA_summary$DE_Strain %in% founders_key$strain),"Colors"] = founders_key[CC_StA_summary[which(CC_StA_summary$DE_Strain %in% founders_key$strain),"DE_Strain"],"collaborative_cross_color_broman"]
CC_StA_summary$DE_Strain = factor(CC_StA_summary$DE_Strain,
                                  levels = CC_StA_summary[order(CC_StA_summary$StA_mean, decreasing = FALSE),"DE_Strain"],
                                  ordered = TRUE)
CC_StA_summary$xlabel = paste(as.character(CC_StA_summary$DE_Strain), sep = "")
CC_StA_plot = ggplot(data = CC_StA_summary, aes(x = DE_Strain, y = StA_mean, fill = DE_Strain)) +
  geom_col(color = "#000000") +
  geom_errorbar(aes(ymin = StA_ll, ymax = StA_ul), width = 0.5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5), legend.position="none") +
  scale_fill_manual(values = CC_StA_summary[order(CC_StA_summary$DE_Strain),"Colors"]) +
  xlab(NULL) +
  ylab("Sessions to Acquistion of IVSA")+ geom_text(aes(
    label= paste(as.character(),CC_StA_summary$StA_n, sep = ""),
    y=1), size = 2.75, hjust = 0.3, vjust = 0.4, angle = 90) 
#+ geom_hline(yintercept=CC_StA_GrandMean, linetype="dashed", color = "red")
CC_StA_plot <- CC_StA_plot + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
CC_StA_plot
ggsave("CC_StA_plot.pdf")

CC_StA_plot
```
```{r}
CC_StA_summary_range = CC_founders_acquisition %>%
  group_by(DE_Strain) %>%
  summarize(StA_mean = mean(AQ_SessionsToAcquisition, na.rm = TRUE),
         StA_max = max(AQ_SessionsToAcquisition, na.rm = TRUE),
         StA_min = min(AQ_SessionsToAcquisition, na.rm = TRUE),
            StA_sem = sd(AQ_SessionsToAcquisition, na.rm = TRUE) / sqrt(length(which(!is.na(AQ_SessionsToAcquisition)))),
            StA_n = length(which(!is.na(AQ_SessionsToAcquisition)))) %>%
  mutate(StA_ul = StA_mean + StA_sem,
         StA_ll = StA_mean - StA_sem)
CC_StA_summary_range = as.data.frame(CC_StA_summary_range)
CC_StA_summary_range$Colors = rep("#CCCCCC", times = nrow(CC_StA_summary_range))
CC_StA_summary_range[which(CC_StA_summary_range$DE_Strain %in% CC_StA_summary_range$strain),"Colors"] = founders_key[CC_StA_summary_range[which(CC_StA_summary_range$DE_Strain %in% founders_key$strain),"DE_Strain"],"collaborative_cross_color_broman"]
CC_StA_summary_range$DE_Strain = factor(CC_StA_summary_range$DE_Strain,
                                  levels = CC_StA_summary_range[order(CC_StA_summary_range$StA_mean, decreasing = FALSE),"DE_Strain"],
                                  ordered = TRUE)
CC_StA_summary_range$xlabel = paste(as.character(CC_StA_summary_range$DE_Strain), sep = "")
```

Plotting Sessions to acquisition in the Founders and CC. Filtering out the DO.

```{r}
CC_founders_acquisition_no_DO = CC_founders_acquisition %>% dplyr::filter((DE_Strain != "J:DO"))
CC_StA_summary = CC_founders_acquisition_no_DO %>%
  group_by(DE_Strain) %>%
  summarize(StA_mean = mean(AQ_SessionsToAcquisition, na.rm = TRUE),
            StA_sem = sd(AQ_SessionsToAcquisition, na.rm = TRUE) / sqrt(length(which(!is.na(AQ_SessionsToAcquisition)))),
            StA_n = length(which(!is.na(AQ_SessionsToAcquisition)))) %>%
  mutate(StA_ul = StA_mean + StA_sem,
         StA_ll = StA_mean - StA_sem)
CC_StA_summary = as.data.frame(CC_StA_summary)
CC_StA_summary$Colors = rep("#CCCCCC", times = nrow(CC_StA_summary))
CC_StA_summary[which(CC_StA_summary$DE_Strain %in% founders_key$strain),"Colors"] = founders_key[CC_StA_summary[which(CC_StA_summary$DE_Strain %in% founders_key$strain),"DE_Strain"],"collaborative_cross_color_broman"]
CC_StA_summary$DE_Strain = factor(CC_StA_summary$DE_Strain,
                                  levels = CC_StA_summary[order(CC_StA_summary$StA_mean, decreasing = FALSE),"DE_Strain"],
                                  ordered = TRUE)
CC_StA_summary$xlabel = paste(as.character(CC_StA_summary$DE_Strain), sep = "")
CC_StA_plot = ggplot(data = CC_StA_summary, aes(x = DE_Strain, y = StA_mean, fill = DE_Strain)) +
  geom_col(color = "#000000") +
  geom_errorbar(aes(ymin = StA_ll, ymax = StA_ul), width = 0.5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5), legend.position="none") +
  scale_fill_manual(values = CC_StA_summary[order(CC_StA_summary$DE_Strain),"Colors"]) +
  xlab(NULL) +
  ylab("Sessions to Acquistion of IVSA")+ geom_text(aes(
    label= paste(as.character(),CC_StA_summary$StA_n, sep = ""),
    y=1), size = 2.75, hjust = 0.3, vjust = 0.4, angle = 90)
# + geom_hline(yintercept=CC_StA_GrandMean, linetype="dashed", color = "red")
CC_StA_plot <- CC_StA_plot + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
CC_StA_plot
ggsave("CC_StA_plot.pdf")

```

### 1.0 mg/kg Dose-Response
Plotting infusions at 1.0 mg/kg in the Founders, CC and DO.

Calculating population grand mean for overlaying on 1.0 mg/kg number of infusions bar plot
```{r}
CC_1p0_inf_GrandMean = mean(CC_founders_acquisition$DR_Inf_Total_1p0mgkg, na.rm = TRUE)
CC_1p0_inf_GrandMean
```
Plotting infusions at 1.0 mg/kg in the Founders, CC and DO with axis modified and grand mean overlaid.
New Format fig.
```{r}
CC_1p0_inf_summary = CC_founders_acquisition %>%
  group_by(DE_Strain) %>%
  summarize(DR_1p0_inf_mean = mean(DR_Inf_Total_1p0mgkg, na.rm = TRUE),
            DR_1p0_inf_sem = sd(DR_Inf_Total_1p0mgkg, na.rm = TRUE) / sqrt(length(which(!is.na(DR_Inf_Total_1p0mgkg)))),
            DR_1p0_inf_n = length(which(!is.na(DR_Inf_Total_1p0mgkg)))) %>%
  mutate(DR_1p0_inf_ul = DR_1p0_inf_mean + DR_1p0_inf_sem,
         DR_1p0_inf_ll = DR_1p0_inf_mean - DR_1p0_inf_sem)
CC_1p0_inf_summary = as.data.frame(CC_1p0_inf_summary)
CC_1p0_inf_summary$Colors = rep("#CCCCCC", times = nrow(CC_1p0_inf_summary))
CC_1p0_inf_summary[which(CC_1p0_inf_summary$DE_Strain %in% founders_key$strain),"Colors"] = founders_key[CC_1p0_inf_summary[which(CC_1p0_inf_summary$DE_Strain %in% founders_key$strain),"DE_Strain"],"collaborative_cross_color_broman"]
CC_1p0_inf_summary$DE_Strain = factor(CC_1p0_inf_summary$DE_Strain,
                                  levels = CC_1p0_inf_summary[order(CC_1p0_inf_summary$DR_1p0_inf_mean, decreasing = FALSE),"DE_Strain"],
                                  ordered = TRUE)
CC_1p0_inf_summary$xlabel =
  paste(as.character(CC_1p0_inf_summary$DE_Strain), sep = "")
CC_1p0_inf_plot = ggplot(data = CC_1p0_inf_summary, aes(x = DE_Strain, y = DR_1p0_inf_mean, fill = DE_Strain)) +
  geom_col(color = "#000000") +
  geom_errorbar(aes(ymin = DR_1p0_inf_ll, ymax = DR_1p0_inf_ul), width = 0.5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5), legend.position="none") +
  scale_fill_manual(values = CC_1p0_inf_summary[order(CC_1p0_inf_summary$DE_Strain),"Colors"]) +
  xlab(NULL) +
  ylab("Total Number of Infusions: FR1 1.0 mg/kg")+ geom_text(aes(
    label= paste(as.character(),CC_1p0_inf_summary$DR_1p0_inf_n, sep = ""),
    y=4), size = 2.75, hjust = 0.3, vjust = 0.4, angle = 90)  
# + geom_hline(yintercept=CC_1p0_inf_GrandMean, linetype="dashed", color = "red")

CC_1p0_inf_plot <- CC_1p0_inf_plot + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
CC_1p0_inf_plot
ggsave("CC_1p0_inf_plot.pdf")

CC_1p0_inf_plot

```
Plotting infusions at 1.0 mg/kg in the Founders and CC, filtering out DO.
New Format fig.
```{r}
CC_founders_acquisition_no_DO = CC_founders_acquisition %>% dplyr::filter((DE_Strain != "J:DO"))
CC_1p0_inf_summary = CC_founders_acquisition_no_DO %>%
  group_by(DE_Strain) %>%
  summarize(DR_1p0_inf_mean = mean(DR_Inf_Total_1p0mgkg, na.rm = TRUE),
            DR_1p0_inf_sem = sd(DR_Inf_Total_1p0mgkg, na.rm = TRUE) / sqrt(length(which(!is.na(DR_Inf_Total_1p0mgkg)))),
            DR_1p0_inf_n = length(which(!is.na(DR_Inf_Total_1p0mgkg)))) %>%
  mutate(DR_1p0_inf_ul = DR_1p0_inf_mean + DR_1p0_inf_sem,
         DR_1p0_inf_ll = DR_1p0_inf_mean - DR_1p0_inf_sem)
CC_1p0_inf_summary = as.data.frame(CC_1p0_inf_summary)
CC_1p0_inf_summary$Colors = rep("#CCCCCC", times = nrow(CC_1p0_inf_summary))
CC_1p0_inf_summary[which(CC_1p0_inf_summary$DE_Strain %in% founders_key$strain),"Colors"] = founders_key[CC_1p0_inf_summary[which(CC_1p0_inf_summary$DE_Strain %in% founders_key$strain),"DE_Strain"],"collaborative_cross_color_broman"]
CC_1p0_inf_summary$DE_Strain = factor(CC_1p0_inf_summary$DE_Strain,
                                  levels = CC_1p0_inf_summary[order(CC_1p0_inf_summary$DR_1p0_inf_mean, decreasing = FALSE),"DE_Strain"],
                                  ordered = TRUE)
CC_1p0_inf_summary$xlabel =
  paste(as.character(CC_1p0_inf_summary$DE_Strain), sep = "")
CC_1p0_inf_plot = ggplot(data = CC_1p0_inf_summary, aes(x = DE_Strain, y = DR_1p0_inf_mean, fill = DE_Strain)) +
  geom_col(color = "#000000") +
  geom_errorbar(aes(ymin = DR_1p0_inf_ll, ymax = DR_1p0_inf_ul), width = 0.5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5), legend.position="none") +
  scale_fill_manual(values = CC_1p0_inf_summary[order(CC_1p0_inf_summary$DE_Strain),"Colors"]) +
  xlab(NULL) +
  ylab("Total Number of Infusions: FR1 1.0 mg/kg")+ geom_text(aes(
    label= paste(as.character(),CC_1p0_inf_summary$DR_1p0_inf_n, sep = ""),
    y=4), size = 2.75, hjust = 0.3, vjust = 0.3, angle = 90)  
#+
# geom_hline(yintercept=CC_1p0_inf_GrandMean, linetype="dashed", color = "red")

CC_1p0_inf_plot <- CC_1p0_inf_plot + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
CC_1p0_inf_plot
ggsave("CC_1p0_inf_plot.pdf")

```

### Fitting ANOVA model for IVSA trait - Sessions To Acquisition

Fitting the model with genetic background (strain) for the entire group -founders, CC and DO. First with Strain and then with Strain and sex.
```{r}
anova(lm(AQ_SessionsToAcquisition ~ DE_Strain, data = CC_founders_acquisition))

anova(lm(AQ_SessionsToAcquisition ~ DE_Strain*DE_Sex, data = CC_founders_acquisition))

```
ANOM with genetic background (strain) for the entire group -founders, CC and DO.

```{r}
Acq_model <- lm(AQ_SessionsToAcquisition ~ DE_Strain, data = CC_founders_acquisition)
Acq_strains <- glht(Acq_model,mcp(DE_Strain="GrandMean"), alternative= "two.sided")
ANOM(Acq_strains)
summary(Acq_strains)
```

Fitting the model to asess effects on sessions to acquisition with founders and CC. First, with strain and then again, with strain and sex.

```{r}
CC_founders_acquisition_no_DO = CC_founders_acquisition %>% dplyr::filter((DE_Strain != "J:DO"))

anova(lm(AQ_SessionsToAcquisition ~ DE_Strain, data = CC_founders_acquisition_no_DO))

anova(lm(AQ_SessionsToAcquisition ~ DE_Strain*DE_Sex, data = CC_founders_acquisition_no_DO))
```

```{r}
Acq_model <- lm(AQ_SessionsToAcquisition ~ DE_Strain, data = CC_founders_acquisition_no_DO)

Acq_strains <- glht(Acq_model,mcp(DE_Strain="GrandMean"), alternative= c("two.sided"))

ANOM(Acq_strains)
summary(Acq_strains)
```

Fitting the model with founders, alone. First, with strain and then again, with strain and sex.
```{r}
ANOVA_founders_IVSA <- CC_founders_acquisition%>%
  filter(DE_Strain %in% founders_key$strain)

ANOVA_founders_IVSA <- ANOVA_founders_IVSA [ which(ANOVA_founders_IVSA$DE_Strain !='J:DO'),]

anova(lm(AQ_SessionsToAcquisition ~ DE_Strain, data = ANOVA_founders_IVSA))

anova(lm(AQ_SessionsToAcquisition ~ DE_Strain*DE_Sex, data = ANOVA_founders_IVSA))
```

Tukey Test on Sessions to Acquisition.
```{r}
AQ_SessionsToAcquisitionFounders.lm <- lm(AQ_SessionsToAcquisition ~ DE_Strain, data = ANOVA_founders_IVSA)
AQ_SessionsToAcquisitionFounders.av <- aov(AQ_SessionsToAcquisitionFounders.lm)
summary(AQ_SessionsToAcquisitionFounders.av)
tukey.test <- TukeyHSD(AQ_SessionsToAcquisitionFounders.av)
tukey.test
```

Fitting the model with CCs, alone. First, with strain and then again, with strain and sex.
```{r}
ANOVA_CC_IVSA <- CC_founders_acquisition[grep("^CC", CC_founders_acquisition$DE_Strain), ] 
anova(lm(AQ_SessionsToAcquisition ~ DE_Strain, data = ANOVA_CC_IVSA))
anova(lm(AQ_SessionsToAcquisition ~ DE_Strain*DE_Sex, data = ANOVA_CC_IVSA))
```

### Fitting ANOVA model for intravenous self-administration dose-response 1.0 mg/kg data

Fitting the model with genetic background (strain) for the entire group -founders, CC and DO.First with Strain and then again with strain and sex.
```{r}
anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain, data = CC_founders_acquisition))

anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain*DE_Sex, data = CC_founders_acquisition))
```
Fitting the model to asess effects on infusions 1.0 mg/kg with founders and CC. First, with strain and then again, with strain and sex.

```{r}
CC_founders_acquisition_no_DO = CC_founders_acquisition %>% dplyr::filter((DE_Strain != "J:DO"))

anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain, data = CC_founders_acquisition_no_DO))

anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain*DE_Sex, data = CC_founders_acquisition_no_DO))
```

```{r}
DR_Inf_Total_1p0mgkg_model <- lm(DR_Inf_Total_1p0mgkg ~ DE_Strain, data = CC_founders_acquisition_no_DO)
DR_Inf_Total_1p0mgkg_strains <- glht(DR_Inf_Total_1p0mgkg_model,mcp(DE_Strain="GrandMean"), alternative= c("two.sided"), rhs= 0)
ANOM(DR_Inf_Total_1p0mgkg_strains)
summary(DR_Inf_Total_1p0mgkg_strains)
```
Fitting the model with founders, alone. First, with strain and then again, with strain and sex.
```{r}
anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain, data = ANOVA_founders_IVSA))
anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain*DE_Sex, data = ANOVA_founders_IVSA))
```

Fitting the model with CCs, alone.First, with strain and then again, with strain and sex.
```{r}
anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain, data = ANOVA_CC_IVSA))
anova(lm(DR_Inf_Total_1p0mgkg ~ DE_Strain*DE_Sex, data = ANOVA_CC_IVSA))
```
ANOM with genetic background (strain) for the entire group -founders, CC and DO.
```{r}
DR_Inf_Total_1p0mgkg_model <- lm(DR_Inf_Total_1p0mgkg ~ DE_Strain, data = CC_founders_acquisition)
DR_Inf_Total_1p0mgkg_strains <- glht(DR_Inf_Total_1p0mgkg_model,mcp(DE_Strain="GrandMean"), alternative= c("two.sided"), rhs= 0)
ANOM(DR_Inf_Total_1p0mgkg_strains)

```

Tukey Test on infusions at 1.0mg/kg.
```{r}
DR_Inf_Total_1p0mgkg.lm <- lm(DR_Inf_Total_1p0mgkg ~ DE_Strain, data = ANOVA_founders_IVSA)
DR_Inf_Total_1p0mgkg.av <- aov(DR_Inf_Total_1p0mgkg.lm)
summary(DR_Inf_Total_1p0mgkg.av)
tukey.test <- TukeyHSD(DR_Inf_Total_1p0mgkg.av)
tukey.test
```
